<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Êï∞Áã¨Ê∏∏Êàè - Sudoku</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            color: #333;
        }

        .container {
            max-width: 600px;
            width: 100%;
        }

        h1 {
            text-align: center;
            color: white;
            margin: 15px 0;
            font-size: 2em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .game-info {
            display: flex;
            justify-content: space-between;
            background: white;
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            flex-wrap: wrap;
            gap: 10px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            min-width: 70px;
        }

        .info-label {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
        }

        .info-value.errors {
            color: #e74c3c;
        }

        .difficulty-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .difficulty-btn {
            flex: 1;
            padding: 10px;
            border: 2px solid white;
            background: rgba(255,255,255,0.2);
            color: white;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .difficulty-btn.active {
            background: white;
            color: #667eea;
            transform: scale(1.05);
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        button {
            flex: 1;
            min-width: 80px;
            padding: 12px 16px;
            border: none;
            border-radius: 10px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }

        button:active {
            transform: scale(0.95);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-secondary {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .btn-hint {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn-check {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .btn-note {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            color: #333;
        }

        .btn-note.active {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            box-shadow: 0 0 15px rgba(255,154,0,0.5);
        }

        .btn-undo {
            background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%);
            color: #333;
        }

        .sudoku-board {
            background: white;
            padding: 10px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            margin-bottom: 15px;
            display: inline-block;
        }

        .sudoku-grid {
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            background: #333;
            border: 3px solid #333;
        }

        .cell {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            border: 1px solid #ddd;
            font-size: clamp(18px, 4vw, 28px);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            user-select: none;
        }

        /* 3x3 ÂÆ´Ê†ºËæπÊ°Ü */
        .cell:nth-child(3n) {
            border-right: 2px solid #333;
        }

        .cell:nth-child(n+19):nth-child(-n+27),
        .cell:nth-child(n+46):nth-child(-n+54) {
            border-bottom: 2px solid #333;
        }

        .cell.initial {
            background: #f0f0f0;
            color: #333;
            cursor: not-allowed;
            font-weight: 700;
        }

        .cell.selected {
            background: #667eea;
            color: white;
        }

        .cell.highlighted {
            background: #e8eaf6;
        }

        .cell.same-number {
            background: #c5cae9;
        }

        .cell.error {
            background: #ffebee;
            color: #e74c3c;
            animation: shake 0.3s;
        }

        .cell.correct {
            animation: flash-green 0.4s ease-out;
        }

        @keyframes flash-green {
            0%, 100% { background: white; }
            50% { background: #4ade80; }
        }

        .cell:not(.initial):hover {
            background: #f5f5f5;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* Á¨îËÆ∞Ê†∑Âºè */
        .notes-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            width: 100%;
            height: 100%;
            padding: 1px;
            position: absolute;
            top: 0;
            left: 0;
        }

        .note-number {
            font-size: clamp(7px, 1.5vw, 11px);
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }

        .number-pad {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            background: white;
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .number-btn {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.5em;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }

        .number-btn:active {
            transform: scale(0.9);
        }

        .number-btn.clear {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            grid-column: span 2;
        }

        /* Â∫ÜÁ•ùÂä®Áîª */
        .celebration {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            text-align: center;
            z-index: 1000;
            animation: popIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes popIn {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        .celebration h2 {
            color: #667eea;
            font-size: 2em;
            margin-bottom: 15px;
        }

        .celebration p {
            color: #666;
            font-size: 1.2em;
            margin-bottom: 10px;
        }

        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            position: absolute;
            animation: confetti-fall 3s linear forwards;
        }

        @keyframes confetti-fall {
            to { transform: translateY(100vh) rotate(360deg); opacity: 0; }
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* ÂìçÂ∫îÂºè */
        @media (max-width: 600px) {
            h1 { font-size: 1.5em; margin: 10px 0; }
            .game-info { padding: 10px; }
            .info-value { font-size: 1.2em; }
            button { padding: 10px 15px; font-size: 0.9em; min-width: 70px; }
            .sudoku-board { padding: 5px; }
            .number-pad { padding: 10px; gap: 8px; }
            .celebration { padding: 30px 20px; }
            .celebration h2 { font-size: 1.5em; }
            .celebration p { font-size: 1em; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ Êï∞Áã¨Ê∏∏Êàè</h1>

        <div class="game-info">
            <div class="info-item">
                <div class="info-label">ÈöæÂ∫¶</div>
                <div class="info-value" id="difficultyDisplay">ÁÆÄÂçï</div>
            </div>
            <div class="info-item">
                <div class="info-label">Êó∂Èó¥</div>
                <div class="info-value" id="timer">00:00</div>
            </div>
            <div class="info-item">
                <div class="info-label">ÈîôËØØ</div>
                <div class="info-value errors" id="errors">0</div>
            </div>
        </div>

        <div class="difficulty-selector">
            <button class="difficulty-btn active" data-difficulty="easy">ÁÆÄÂçï</button>
            <button class="difficulty-btn" data-difficulty="medium">‰∏≠Á≠â</button>
            <button class="difficulty-btn" data-difficulty="hard">Âõ∞Èöæ</button>
        </div>

        <div class="controls">
            <button class="btn-primary" id="newGameBtn">Êñ∞Ê∏∏Êàè</button>
            <button class="btn-undo" id="undoBtn">‚Ü∂ Êí§ÈîÄ</button>
            <button class="btn-note" id="noteBtn">üìù Á¨îËÆ∞</button>
            <button class="btn-hint" id="hintBtn">üí° ÊèêÁ§∫</button>
            <button class="btn-check" id="checkBtn">‚úì Ê£ÄÊü•</button>
        </div>

        <div class="sudoku-board">
            <div class="sudoku-grid" id="sudokuGrid"></div>
        </div>

        <div class="number-pad">
            <button class="number-btn" data-number="1">1</button>
            <button class="number-btn" data-number="2">2</button>
            <button class="number-btn" data-number="3">3</button>
            <button class="number-btn" data-number="4">4</button>
            <button class="number-btn" data-number="5">5</button>
            <button class="number-btn" data-number="6">6</button>
            <button class="number-btn" data-number="7">7</button>
            <button class="number-btn" data-number="8">8</button>
            <button class="number-btn" data-number="9">9</button>
            <button class="number-btn clear" data-number="0">Ê∏ÖÈô§</button>
        </div>
    </div>

    <script>
        // ==================== Êï∞Áã¨Ê∏∏ÊàèÊ†∏ÂøÉÈÄªËæë ====================

        class SudokuGame {
            constructor() {
                this.board = Array(9).fill(null).map(() => Array(9).fill(0));
                this.solution = Array(9).fill(null).map(() => Array(9).fill(0));
                this.initialBoard = Array(9).fill(null).map(() => Array(9).fill(0));
                this.notes = Array(9).fill(null).map(() => Array(9).fill(null).map(() => new Set()));
                this.selectedCell = null;
                this.difficulty = 'easy';
                this.errors = 0;
                this.startTime = null;
                this.timerInterval = null;
                this.noteMode = false;
                this.history = [];
                this.maxHistory = 30;

                this.difficultySettings = {
                    easy: { cellsToRemove: 35, technique: 'naked_single' },
                    medium: { cellsToRemove: 45, technique: 'hidden_single' },
                    hard: { cellsToRemove: 55, technique: 'advanced' }
                };

                this.init();
            }

            init() {
                this.createGrid();
                this.bindEvents();
                this.loadGame();
            }

            // ÂàõÂª∫ÁΩëÊ†º DOM
            createGrid() {
                const grid = document.getElementById('sudokuGrid');
                grid.innerHTML = '';
                for (let i = 0; i < 81; i++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.dataset.index = i;
                    grid.appendChild(cell);
                }
            }

            // ÁªëÂÆö‰∫ã‰ª∂
            bindEvents() {
                // Ê†ºÂ≠êÁÇπÂáª
                document.getElementById('sudokuGrid').addEventListener('click', (e) => {
                    if (e.target.classList.contains('cell')) {
                        this.selectCell(parseInt(e.target.dataset.index));
                    }
                });

                // Êï∞Â≠óÈîÆÁõò
                document.querySelectorAll('.number-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        this.inputNumber(parseInt(btn.dataset.number));
                    });
                });

                // ÈîÆÁõòËæìÂÖ•
                document.addEventListener('keydown', (e) => {
                    if (e.key >= '1' && e.key <= '9') {
                        this.inputNumber(parseInt(e.key));
                    } else if (e.key === 'Backspace' || e.key === 'Delete' || e.key === '0') {
                        this.inputNumber(0);
                    } else if (e.ctrlKey && e.key === 'z') {
                        e.preventDefault();
                        this.undo();
                    }
                });

                // ÈöæÂ∫¶ÈÄâÊã©
                document.querySelectorAll('.difficulty-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        document.querySelectorAll('.difficulty-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        this.difficulty = btn.dataset.difficulty;
                        document.getElementById('difficultyDisplay').textContent = btn.textContent;
                        this.newGame();
                    });
                });

                // ÊåâÈíÆ‰∫ã‰ª∂
                document.getElementById('newGameBtn').addEventListener('click', () => this.newGame());
                document.getElementById('undoBtn').addEventListener('click', () => this.undo());
                document.getElementById('noteBtn').addEventListener('click', () => this.toggleNoteMode());
                document.getElementById('hintBtn').addEventListener('click', () => this.showHint());
                document.getElementById('checkBtn').addEventListener('click', () => this.checkSolution());
            }

            // ÂàáÊç¢Á¨îËÆ∞Ê®°Âºè
            toggleNoteMode() {
                this.noteMode = !this.noteMode;
                const btn = document.getElementById('noteBtn');
                btn.classList.toggle('active', this.noteMode);
                btn.textContent = this.noteMode ? 'üìù Á¨îËÆ∞ ON' : 'üìù Á¨îËÆ∞';
            }

            // Êí§ÈîÄ
            undo() {
                if (this.history.length === 0) {
                    alert('Ê≤°ÊúâÂèØÊí§ÈîÄÁöÑÊìç‰ΩúÔºÅ');
                    return;
                }

                const action = this.history.pop();
                const { row, col, type, oldValue, oldNotes } = action;

                if (type === 'number') {
                    this.board[row][col] = oldValue;
                } else if (type === 'note') {
                    this.notes[row][col] = oldNotes;
                }

                this.render();
                this.saveGame();
            }

            // ËÆ∞ÂΩïÊìç‰ΩúÂà∞ÂéÜÂè≤
            recordAction(row, col, type, oldValue, oldNotes) {
                this.history.push({ row, col, type, oldValue, oldNotes });
                if (this.history.length > this.maxHistory) {
                    this.history.shift();
                }
            }

            // Êñ∞Ê∏∏Êàè
            newGame() {
                this.errors = 0;
                this.selectedCell = null;
                this.noteMode = false;
                this.history = [];
                this.notes = Array(9).fill(null).map(() => Array(9).fill(null).map(() => new Set()));
                this.updateErrors();
                document.getElementById('noteBtn').classList.remove('active');
                document.getElementById('noteBtn').textContent = 'üìù Á¨îËÆ∞';
                this.stopTimer();
                this.startTimer();

                this.generateSudoku();
                this.removeNumbersWithUniqueSolution();
                this.render();
                this.saveGame();
            }

            // ÁîüÊàêÂÆåÊï¥Êï∞Áã¨
            generateSudoku() {
                this.board = Array(9).fill(null).map(() => Array(9).fill(0));
                for (let i = 0; i < 9; i += 3) {
                    this.fillBox(i, i);
                }
                this.solveSudoku(this.board);
                this.solution = this.board.map(row => [...row]);
            }

            // Â°´ÂÖÖ 3x3 ÂÆ´Ê†º
            fillBox(row, col) {
                const numbers = [1, 2, 3, 4, 5, 6, 7, 8, 9];
                this.shuffle(numbers);
                let idx = 0;
                for (let i = 0; i < 3; i++) {
                    for (let j = 0; j < 3; j++) {
                        this.board[row + i][col + j] = numbers[idx++];
                    }
                }
            }

            // Ê¥óÁâåÁÆóÊ≥ï
            shuffle(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
            }

            // Ê£ÄÊü•ÊòØÂê¶ÊúâÊïà
            isValid(board, row, col, num) {
                for (let x = 0; x < 9; x++) {
                    if (board[row][x] === num || board[x][col] === num) return false;
                }
                const startRow = row - row % 3;
                const startCol = col - col % 3;
                for (let i = 0; i < 3; i++) {
                    for (let j = 0; j < 3; j++) {
                        if (board[startRow + i][startCol + j] === num) return false;
                    }
                }
                return true;
            }

            // Ê±ÇËß£Êï∞Áã¨ÔºàÂõûÊ∫ØÔºâ
            solveSudoku(board) {
                for (let row = 0; row < 9; row++) {
                    for (let col = 0; col < 9; col++) {
                        if (board[row][col] === 0) {
                            const numbers = [1, 2, 3, 4, 5, 6, 7, 8, 9];
                            this.shuffle(numbers);
                            for (let num of numbers) {
                                if (this.isValid(board, row, col, num)) {
                                    board[row][col] = num;
                                    if (this.solveSudoku(board)) return true;
                                    board[row][col] = 0;
                                }
                            }
                            return false;
                        }
                    }
                }
                return true;
            }

            // ËÆ°ÁÆóËß£ÁöÑÊï∞ÈáèÔºàÁî®‰∫éÁ°Æ‰øùÂîØ‰∏ÄËß£Ôºâ
            countSolutions(board, limit = 2) {
                let count = 0;
                const boardCopy = board.map(row => [...row]);

                const solve = (b) => {
                    if (count >= limit) return;
                    for (let row = 0; row < 9; row++) {
                        for (let col = 0; col < 9; col++) {
                            if (b[row][col] === 0) {
                                for (let num = 1; num <= 9; num++) {
                                    if (this.isValid(b, row, col, num)) {
                                        b[row][col] = num;
                                        solve(b);
                                        b[row][col] = 0;
                                    }
                                }
                                return;
                            }
                        }
                    }
                    count++;
                };

                solve(boardCopy);
                return count;
            }

            // ÁßªÈô§Êï∞Â≠óÂπ∂Á°Æ‰øùÂîØ‰∏ÄËß£
            removeNumbersWithUniqueSolution() {
                const cellsToRemove = this.difficultySettings[this.difficulty].cellsToRemove;
                this.initialBoard = this.board.map(row => [...row]);

                let positions = [];
                for (let i = 0; i < 81; i++) {
                    positions.push(i);
                }
                this.shuffle(positions);

                let removed = 0;
                for (let pos of positions) {
                    if (removed >= cellsToRemove) break;

                    const row = Math.floor(pos / 9);
                    const col = pos % 9;

                    if (this.board[row][col] !== 0) {
                        const backup = this.board[row][col];
                        this.board[row][col] = 0;

                        // Ê£ÄÊü•ÊòØÂê¶‰ªçÊúâÂîØ‰∏ÄËß£
                        if (this.countSolutions(this.board, 2) !== 1) {
                            this.board[row][col] = backup; // ÊÅ¢Â§ç
                        } else {
                            removed++;
                        }
                    }
                }

                this.initialBoard = this.board.map(row => [...row]);
            }

            // ÈÄâÊã©Ê†ºÂ≠ê
            selectCell(index) {
                const row = Math.floor(index / 9);
                const col = index % 9;

                if (this.initialBoard[row][col] !== 0) {
                    return;
                }

                this.selectedCell = { row, col, index };
                this.render();
            }

            // ËæìÂÖ•Êï∞Â≠ó
            inputNumber(number) {
                if (!this.selectedCell) return;

                const { row, col } = this.selectedCell;

                if (this.noteMode && number !== 0) {
                    // Á¨îËÆ∞Ê®°Âºè
                    const oldNotes = new Set(this.notes[row][col]);
                    if (this.notes[row][col].has(number)) {
                        this.notes[row][col].delete(number);
                    } else {
                        this.notes[row][col].add(number);
                    }
                    this.recordAction(row, col, 'note', null, oldNotes);
                } else {
                    // ÊôÆÈÄöÊ®°Âºè
                    const oldValue = this.board[row][col];
                    this.recordAction(row, col, 'number', oldValue, null);

                    if (number === 0) {
                        this.board[row][col] = 0;
                        this.notes[row][col].clear();
                    } else {
                        this.board[row][col] = number;
                        this.notes[row][col].clear();

                        // Ê£ÄÊü•Ê≠£Á°ÆÊÄß
                        if (this.solution[row][col] === number) {
                            // Ê≠£Á°Æ - ÁªøËâ≤Èó™ÂÖâ
                            const cell = document.querySelector(`[data-index="${row * 9 + col}"]`);
                            cell.classList.add('correct');
                            setTimeout(() => cell.classList.remove('correct'), 400);

                            // ‰ªéÁõ∏ÂÖ≥Ê†ºÂ≠ê‰∏≠ÁßªÈô§Á¨îËÆ∞
                            this.removeNoteFromRelated(row, col, number);
                        } else {
                            // ÈîôËØØ
                            this.errors++;
                            this.updateErrors();
                        }
                    }
                }

                this.render();
                this.saveGame();

                // Ê£ÄÊü•ÂÆåÊàê
                if (this.isComplete()) {
                    this.stopTimer();
                    this.showCelebration();
                    localStorage.removeItem('sudoku-save');
                }
            }

            // ‰ªéÁõ∏ÂÖ≥Ê†ºÂ≠êÁßªÈô§Á¨îËÆ∞
            removeNoteFromRelated(row, col, number) {
                // Âêå‰∏ÄË°å
                for (let c = 0; c < 9; c++) {
                    this.notes[row][c].delete(number);
                }
                // Âêå‰∏ÄÂàó
                for (let r = 0; r < 9; r++) {
                    this.notes[r][col].delete(number);
                }
                // Âêå‰∏ÄÂÆ´Ê†º
                const startRow = Math.floor(row / 3) * 3;
                const startCol = Math.floor(col / 3) * 3;
                for (let r = startRow; r < startRow + 3; r++) {
                    for (let c = startCol; c < startCol + 3; c++) {
                        this.notes[r][c].delete(number);
                    }
                }
            }

            // ÊèêÁ§∫
            showHint() {
                if (!this.selectedCell) {
                    alert('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™Ê†ºÂ≠êÔºÅ');
                    return;
                }

                const { row, col } = this.selectedCell;

                if (this.board[row][col] !== 0) {
                    alert('Ëøô‰∏™Ê†ºÂ≠êÂ∑≤ÁªèÊúâÊï∞Â≠ó‰∫ÜÔºÅ');
                    return;
                }

                this.board[row][col] = this.solution[row][col];
                this.notes[row][col].clear();
                this.render();
                this.saveGame();

                if (this.isComplete()) {
                    this.stopTimer();
                    this.showCelebration();
                }
            }

            // Ê£ÄÊü•Á≠îÊ°à
            checkSolution() {
                let hasErrors = false;

                for (let row = 0; row < 9; row++) {
                    for (let col = 0; col < 9; col++) {
                        if (this.board[row][col] !== 0 &&
                            this.board[row][col] !== this.solution[row][col]) {
                            hasErrors = true;
                            const index = row * 9 + col;
                            const cell = document.querySelector(`[data-index="${index}"]`);
                            cell.classList.add('error');
                        }
                    }
                }

                if (!hasErrors) {
                    if (this.isComplete()) {
                        this.stopTimer();
                        this.showCelebration();
                    } else {
                        alert('ÁõÆÂâçÂ°´ÂÜôÁöÑÈÉΩÊ≠£Á°ÆÔºåÁªßÁª≠Âä†Ê≤πÔºÅ');
                    }
                } else {
                    setTimeout(() => this.render(), 1000);
                }
            }

            // ÊòØÂê¶ÂÆåÊàê
            isComplete() {
                for (let row = 0; row < 9; row++) {
                    for (let col = 0; col < 9; col++) {
                        if (this.board[row][col] === 0) return false;
                    }
                }
                return true;
            }

            // Ê∏≤Êüì
            render() {
                const cells = document.querySelectorAll('.cell');

                cells.forEach((cell, index) => {
                    const row = Math.floor(index / 9);
                    const col = index % 9;
                    const value = this.board[row][col];

                    cell.className = 'cell';
                    cell.textContent = '';

                    // ÂàùÂßãÊï∞Â≠ó
                    if (this.initialBoard[row][col] !== 0) {
                        cell.classList.add('initial');
                        cell.textContent = value;
                    } else if (value !== 0) {
                        // Áî®Êà∑Â°´ÂÜôÁöÑÊï∞Â≠ó
                        cell.textContent = value;
                        if (this.solution[row][col] !== value) {
                            cell.classList.add('error');
                        }
                    } else {
                        // Á¨îËÆ∞
                        const notes = this.notes[row][col];
                        if (notes.size > 0) {
                            const notesContainer = document.createElement('div');
                            notesContainer.className = 'notes-container';
                            for (let n = 1; n <= 9; n++) {
                                const noteDiv = document.createElement('div');
                                noteDiv.className = 'note-number';
                                noteDiv.textContent = notes.has(n) ? n : '';
                                notesContainer.appendChild(noteDiv);
                            }
                            cell.appendChild(notesContainer);
                        }
                    }

                    // ÈÄâ‰∏≠
                    if (this.selectedCell && this.selectedCell.index === index) {
                        cell.classList.add('selected');
                    }

                    // È´ò‰∫ÆÁõ∏ÂÖ≥Ê†ºÂ≠ê
                    if (this.selectedCell) {
                        const sr = this.selectedCell.row;
                        const sc = this.selectedCell.col;

                        if (row === sr || col === sc) {
                            cell.classList.add('highlighted');
                        }

                        if (Math.floor(row / 3) === Math.floor(sr / 3) &&
                            Math.floor(col / 3) === Math.floor(sc / 3)) {
                            cell.classList.add('highlighted');
                        }
                    }

                    // È´ò‰∫ÆÁõ∏ÂêåÊï∞Â≠ó
                    if (this.selectedCell && value !== 0) {
                        const sv = this.board[this.selectedCell.row][this.selectedCell.col];
                        if (sv !== 0 && value === sv) {
                            cell.classList.add('same-number');
                        }
                    }
                });
            }

            // ËÆ°Êó∂Âô®
            startTimer() {
                this.startTime = Date.now();
                this.timerInterval = setInterval(() => {
                    const elapsed = Math.floor((Date.now() - this.startTime) / 1000);
                    const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
                    const seconds = (elapsed % 60).toString().padStart(2, '0');
                    document.getElementById('timer').textContent = `${minutes}:${seconds}`;
                }, 1000);
            }

            stopTimer() {
                if (this.timerInterval) {
                    clearInterval(this.timerInterval);
                    this.timerInterval = null;
                }
            }

            updateErrors() {
                document.getElementById('errors').textContent = this.errors;
            }

            // ‰øùÂ≠òÊ∏∏Êàè
            saveGame() {
                const saveData = {
                    board: this.board,
                    solution: this.solution,
                    initialBoard: this.initialBoard,
                    notes: this.notes.map(row => row.map(set => Array.from(set))),
                    difficulty: this.difficulty,
                    errors: this.errors,
                    elapsedTime: this.startTime ? Date.now() - this.startTime : 0
                };
                localStorage.setItem('sudoku-save', JSON.stringify(saveData));
            }

            // Âä†ËΩΩÊ∏∏Êàè
            loadGame() {
                const saved = localStorage.getItem('sudoku-save');
                if (saved) {
                    try {
                        const data = JSON.parse(saved);
                        this.board = data.board;
                        this.solution = data.solution;
                        this.initialBoard = data.initialBoard;
                        this.notes = data.notes.map(row => row.map(arr => new Set(arr)));
                        this.difficulty = data.difficulty;
                        this.errors = data.errors;

                        document.querySelectorAll('.difficulty-btn').forEach(btn => {
                            btn.classList.toggle('active', btn.dataset.difficulty === this.difficulty);
                        });
                        document.getElementById('difficultyDisplay').textContent =
                            this.difficulty === 'easy' ? 'ÁÆÄÂçï' :
                            this.difficulty === 'medium' ? '‰∏≠Á≠â' : 'Âõ∞Èöæ';

                        this.startTimer();
                        this.startTime = Date.now() - data.elapsedTime;
                        this.updateErrors();
                        this.render();
                    } catch (e) {
                        console.error('Âä†ËΩΩÂ≠òÊ°£Â§±Ë¥•', e);
                        this.newGame();
                    }
                } else {
                    this.newGame();
                }
            }

            // Â∫ÜÁ•ùÂä®Áîª
            showCelebration() {
                const elapsed = Math.floor((Date.now() - this.startTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;

                const overlay = document.createElement('div');
                overlay.className = 'overlay';

                const celebration = document.createElement('div');
                celebration.className = 'celebration';
                celebration.innerHTML = `
                    <h2>üéâ ÊÅ≠ÂñúÂÆåÊàêÔºÅ</h2>
                    <p>Áî®Êó∂: ${minutes}ÂàÜ${seconds}Áßí</p>
                    <p>ÈîôËØØ: ${this.errors}Ê¨°</p>
                    <button class="btn-primary" onclick="location.reload()">ÂÜçÊù•‰∏ÄÂ±Ä</button>
                `;

                document.body.appendChild(overlay);
                document.body.appendChild(celebration);

                this.createConfetti();

                overlay.addEventListener('click', () => {
                    overlay.remove();
                    celebration.remove();
                });
            }

            // ‰∫îÂΩ©Á∫∏Â±ë
            createConfetti() {
                const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff'];
                for (let i = 0; i < 50; i++) {
                    setTimeout(() => {
                        const confetti = document.createElement('div');
                        confetti.className = 'confetti';
                        confetti.style.left = Math.random() * window.innerWidth + 'px';
                        confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                        confetti.style.animationDelay = Math.random() * 2 + 's';
                        document.body.appendChild(confetti);
                        setTimeout(() => confetti.remove(), 3000);
                    }, i * 50);
                }
            }
        }

        // ÂêØÂä®Ê∏∏Êàè
        const game = new SudokuGame();
    </script>
</body>
</html>
